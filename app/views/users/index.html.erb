<main>
  <section class="emergency-notification">
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // 位置情報を取得し、サーバーに送信する
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            fetch('/users/update_location', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '<%= form_authenticity_token %>'
              },
              body: JSON.stringify({
                latitude: position.coords.latitude,
                longitude: position.coords.longitude
              })
            });
          });
        } else {
          alert("現在位置情報を取得できませんでした。");
        }
      });
    </script>
    
    <!-- 災害通知の表示 -->
    <section class="disaster-notifications">
      <h2>周辺エリアの災害通知</h2>

      <% if @nearby_notifications.present? %>
        <ul>
          <% @nearby_notifications.each do |notification| %>
            <li>
              <strong>災害名:</strong> <%= notification.title %><br>
              <strong>発生日時:</strong> <%= notification.occurred_at.strftime("%Y年%m月%d日 %H:%M") %><br>
              <strong>詳細:</strong> <%= notification.details %><br>
              <strong>場所:</strong> <%= notification.location %>
            </li>
          <% end %>
        </ul>
      <% else %>
        <p>周辺エリアに災害通知はありません。</p>
      <% end %>
    </section>
  </section>

  <!-- 避難所検索 -->
  <section class="search-shelter">
    <h2>避難所検索</h2>
    <!-- 現在地から検索ボタン -->
    <button id="search-shelter-button">現在地から検索</button>
    <div id="shelter-list"></div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // 現在地から検索ボタンがクリックされたときの処理
        document.getElementById('search-shelter-button').addEventListener('click', function () {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
              const userLat = position.coords.latitude;
              const userLon = position.coords.longitude;

              fetch('/shelters/nearby', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRF-Token': '<%= form_authenticity_token %>'
                },
                body: JSON.stringify({
                  latitude: userLat,
                  longitude: userLon
                })
              })
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
              .then(data => {
                const shelterList = document.getElementById('shelter-list');
                shelterList.innerHTML = '';

                if (data.shelters && data.shelters.length > 0) {
                  data.shelters.forEach(shelter => {
                    const shelterItem = document.createElement('div');
                    shelterItem.textContent = `${shelter.name} (${shelter.distance.toFixed(2)} km) - ${shelter.address}`;
                    shelterList.appendChild(shelterItem);
                  });
                } else {
                  shelterList.textContent = '近くの避難所が見つかりませんでした。';
                }
              })
              .catch(error => {
                console.error('Error:', error);
          alert('避難所の検索に失敗しました。');
              });
            }, function(error) {
              console.error('Error getting location:', error);
            });
          } else {
            alert('Geolocation is not supported by this browser.');
          }
        });
      });
    </script>
  </section>

  <!-- 物資管理 -->
  <h1>物資管理</h1>

  <% if user_signed_in? %>
    <!-- 必要な物のチェックリスト -->
    <section class="checklist">
      <h2>必要な物のチェックリスト</h2>
      <ul>
        <% if @necessary_supplies.present? %>
          <% @necessary_supplies.each do |item| %>
            <li>
              <%= check_box_tag "supply[type]", 'required_item', false, id: "supply_#{item.id}" %>
              <%= item.name %>
            </li>
          <% end %>
        <% else %>
          <p>必要な物がありません。</p>
        <% end %>
      </ul>
    </section>

    <!-- 備蓄品のリマインダー -->
    <section class="reminders">
      <h2>備蓄品のリマインダー</h2>
      <ul>
        <% if @stock_supplies.present? %>
          <% @stock_supplies.each do |supply| %>
            <li>
              <%= supply.name %> (賞味期限: <%= supply.expiration_date.strftime("%Y年%m月%d日") if supply.expiration_date %>)
            </li>
          <% end %>
        <% else %>
          <p>備蓄品がありません。</p>
        <% end %>
      </ul>
    </section>

    <!-- ユーザーの最近のアクティビティ -->
    <section class="user-activity">
      <h2>最近のアクティビティ</h2>
      <p>最後のログイン: <%= current_user.last_login_at.strftime("%Y年%m月%d日 %H:%M") if current_user.last_login_at %></p>
    </section>
  <% end %>

  <!-- 災害マニュアル -->
  <section class="manual">
    <h2>災害マニュアル</h2>
    <%= link_to '地震マニュアル', earthquake_manual_index_path %><br>
    <%= link_to '台風マニュアル', typhoon_manual_index_path %><br>
  </section>
</main>